<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCARTS-previewer (Volume Control)</title>
  <style>
    body {
      font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
      background-color: #222;
      color: #fff;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 140px;
    }

    .file-select-area {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      width: 90%;
      max-width: 800px;
      border: 2px dashed #555;
    }

    .lyrics-box {
      background: #111;
      border: 1px solid #444;
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      height: 150px;
      overflow-y: auto;
      margin-top: 20px;
      padding: 20px;
      margin-bottom: 30px;
      white-space: pre-wrap;
      font-size: 1rem;
      line-height: 1.8;
      color: #ddd;
      text-align: center;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 15px;
      width: 100%;
      max-width: 1400px;
    }

    .channel-box {
      background: #000;
      border: 1px solid #444;
      border-radius: 6px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .file-name-display {
      background: #333;
      color: #fff;
      font-size: 0.8rem;
      padding: 4px 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-bottom: 1px solid #444;
    }

    .video-wrapper {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #111;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      position: relative;
      z-index: 1;
    }

    .placeholder-text {
      position: absolute;
      font-size: 2rem;
      color: #555;
      font-weight: bold;
      z-index: 0;
    }

    .audio-icon {
      display: none;
      position: absolute;
      font-size: 3rem;
      color: #4CAF50;
      z-index: 2;
      flex-direction: column;
      align-items: center;
    }

    .audio-icon span {
      font-size: 0.8rem;
      margin-top: 5px;
      color: #aaa;
    }

    .video-wrapper.is-audio video {
      opacity: 0;
    }

    .video-wrapper.is-audio .audio-icon {
      display: flex;
    }

    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰æ›´ */
    .controls-row {
      display: flex;
      align-items: center;
      background: #444;
      border-top: 1px solid #333;
      padding: 5px 10px;
      gap: 10px;
    }

    .audio-btn {
      flex-grow: 1;
      /* ãƒœã‚¿ãƒ³ã‚’åºƒã’ã‚‹ */
      padding: 8px;
      border: none;
      background: #555;
      color: #ccc;
      font-size: 0.8rem;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .audio-btn:hover {
      background: #666;
    }

    .audio-btn.active {
      background: #4CAF50;
      color: #fff;
      font-weight: bold;
    }

    /* ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
    .vol-slider {
      width: 80px;
      cursor: pointer;
    }

    .sync-status {
      font-size: 0.75rem;
      color: #666;
      text-align: center;
      padding: 2px;
      background: #1a1a1a;
    }

    .main-controls {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.95);
      padding: 15px 30px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      gap: 20px;
      z-index: 1000;
      border-top: 1px solid #444;
    }

    button.play-btn {
      width: 80px;
      height: 40px;
      cursor: pointer;
      font-size: 1rem;
      background: #fff;
      color: #000;
      border: none;
      border-radius: 4px;
      font-weight: bold;
    }

    input[type="range"] {
      cursor: pointer;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã¯å¤§ãã */
    #masterSeek {
      flex-grow: 1;
      height: 10px;
    }

    .time-display {
      font-family: monospace;
      width: 100px;
      text-align: right;
      font-size: 1.2rem;
    }
  </style>
</head>

<body>

  <div class="file-select-area">
    <h3>STEP 1: å‹•ç”»ãƒ»éŸ³å£°ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</h3>
    <p style="margin:5px 0; font-size:0.9rem; color:#aaa;">â€»ãƒ•ã‚¡ã‚¤ãƒ«åé †ã«1ï½7ç•ªã¸å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ (mp4, mp3, wavç­‰)</p>
    <input type="file" id="folderInput" webkitdirectory directory multiple>
  </div>

  <div class="video-grid">
    <script>
      // 7å€‹åˆ†ã®HTMLæ ã‚’ç”Ÿæˆï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¿½åŠ ï¼‰
      for (let i = 1; i <= 7; i++) {
        document.write(`
          <div class="channel-box">
              <div class="file-name-display" id="fname${i}">No File</div>
              <div class="video-wrapper" id="wrap${i}">
                  <span class="placeholder-text">${i}</span>
                  <div class="audio-icon">
                    ğŸµ
                    <span>Audio Only</span>
                  </div>
                  <video id="vid${i}" playsinline></video>
              </div>
              <div class="sync-status" id="status${i}">Sync: OK</div>
              <div class="controls-row">
                  <button class="audio-btn" id="btn${i}" onclick="toggleAudio(${i - 1})">OFF</button>
                  <input type="range" class="vol-slider" id="vol${i}" min="0" max="1" step="0.01" value="1" oninput="changeVolume(${i - 1}, this.value)">
              </div>
          </div>
        `);
      }
    </script>
  </div>

  <div class="main-controls">
    <button class="play-btn" id="masterPlay">Play</button>
    <input type="range" id="masterSeek" value="0" min="0" step="0.1">
    <span class="time-display" id="timeDisplay">00:00</span>
  </div>

  <div class="lyrics-box">
    "ã•ã‚‰ã®ã†ãˆã«ã«ãã‚",
    "ã‚ã‚‹ã®ã«ã‚ãŸã—ã®",
    "ã«ããŸã„ã®ã•ã‚‰ã‚",
    "ãªã„ã“ã¨ã‚ã–ãƒ¼ãƒ¼",
    "ã¿ãŸã„ã§ã‚‚ã ã‚Œã‚‚",
    "ã†ãªãšã‹ãªã„ãƒ¼ãƒ¼",
    "ã­ã‚“ãã‚“ã‚ã«ãã®",
    "ã†ãˆã‚’ã¨ãŠã‚Šãƒ¼ãƒ¼",
    "ã›ã‹ã„ã‚’ãŠã¼ãˆã‚‹",
    "ãã‚‹ã’ã‚‹ã‹ãŸã„ãƒ¼",
    "ã’ã‚‹ã²ã‚„ã‚Šã¾ãŸãƒ¼",
    "ã‚ã¤ã„ã‹ããˆããƒ¼",
    "ã¦ã„ã—ã‚ƒã§ã‚“ã—ã‚ƒãƒ¼ãƒ¼",
    "ã²ã‚„ã‚ã›ãƒ¼ãƒ¼ãƒ¼ãƒ¼",
    "ãŠã‹ã‚ã•ã‚“ã‚ã«ã",
    "ã‚’ãµã‚„ã™ãµã‚ã‚“ã®",
    "ã¦ã—ã„ãã“ã‚„ã§ãƒ¼",
    "ã‚Šã‚“ã‹ããŒã¨ã‘ãƒ¼",
    "ã‚ãŸã—ãŒã¾ã–ã‚‹ãƒ¼",
    "ã¡ã‚ƒã„ã‚ã„ã‹ãŸã¾ã‚Š",
    "ã†ã‚“ã“ã‹ã ã‚“ã”ã‹",
    "ã—ã‚ƒãƒ¼ã‚Œã«ã½ã¤ã‚Šãƒ¼",
    "ãŠã¨ã®ãªã„ã«ãã†ãã¨ãƒ¼ãƒ¼",
    "ã»ã‚“ã¨ã†ã®ãµã ã‚†ã‚Œã‚‹",
    "ã‹ã¾ã‚Œã¬ã«ããƒ¼ãƒ¼",
    "ã­ã‚€ã‚‰ã¬ã«ããƒ¼ãƒ¼",
    "ã­ã‚“ãã‚“ã®ã‚ã¨ãƒ¼",
    "ã ã‘ã—ã‚‡ã†ã‚ã„ãƒ¼ãƒ¼",
    "ã¿ãŸã„ã«ã®ã“ã‚‹ã„ã‚Œã®",
    "ã‚ãŸã—ã‚ˆã†ã«ã•ã‚‰",
    "ã‚’ã‹ã‹ãˆã™ããªããƒ¼",
    "ã¦ã‚‚ã„ãã‚‹ãƒ¼ãƒ¼ãƒ¼",
    "ã›ã„ã‚ã„"
  </div>

  <script>
    // è¦ç´ å–å¾—
    const videoElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`vid${i + 1}`));
    const btnElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`btn${i + 1}`));
    const volElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`vol${i + 1}`));
    const statusElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`status${i + 1}`));
    const nameElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`fname${i + 1}`));
    const wrapperElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`wrap${i + 1}`));

    const folderInput = document.getElementById('folderInput');
    const playBtn = document.getElementById('masterPlay');
    const seek = document.getElementById('masterSeek');
    const timeDisplay = document.getElementById('timeDisplay');

    let audioCtx;
    const gainNodes = [];
    let audioSources = [];

    // å„ãƒãƒ£ãƒ³ãƒãƒ«ã®çŠ¶æ…‹ç®¡ç† (volume: ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤, muted: ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹)
    const channelStates = Array.from({ length: 7 }, () => ({ volume: 1.0, muted: true }));

    let isPlaying = false;
    let masterDuration = 0;

    function initAudioContext() {
      if (!audioCtx) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
      }
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
    }

    folderInput.addEventListener('change', async (e) => {
      initAudioContext();

      const files = Array.from(e.target.files);
      const mediaFiles = files.filter(f =>
        f.type.startsWith('video/') ||
        f.type.startsWith('audio/') ||
        f.name.match(/\.(mp4|mov|webm|m4v|mkv|mp3|wav|aac|ogg)$/i)
      );

      if (mediaFiles.length === 0) {
        alert("å†ç”Ÿå¯èƒ½ãªãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«(å‹•ç”»/éŸ³å£°)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
        return;
      }

      mediaFiles.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));

      // ãƒªã‚»ãƒƒãƒˆ
      audioSources.forEach(src => src.disconnect());
      audioSources = [];
      gainNodes.length = 0;

      for (let i = 0; i < 7; i++) {
        const vid = videoElements[i];
        const btn = btnElements[i];
        const vol = volElements[i];
        const nameLabel = nameElements[i];
        const wrapper = wrapperElements[i];

        // çŠ¶æ…‹åˆæœŸåŒ–
        channelStates[i].muted = true;
        channelStates[i].volume = 1.0;
        vol.value = 1.0; // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’æœ€å¤§ã«æˆ»ã™
        btn.textContent = "OFF";
        btn.classList.remove('active');

        if (mediaFiles[i]) {
          const file = mediaFiles[i];
          const fileURL = URL.createObjectURL(file);

          vid.src = fileURL;
          vid.load();

          vid.parentElement.querySelector('.placeholder-text').style.display = 'none';
          nameLabel.textContent = file.name;
          nameLabel.title = file.name;

          const isAudio = file.type.startsWith('audio/') || file.name.match(/\.(mp3|wav|aac|ogg)$/i);
          if (isAudio) wrapper.classList.add('is-audio');
          else wrapper.classList.remove('is-audio');

          // Audio Node è¨­å®š
          const source = audioCtx.createMediaElementSource(vid);
          audioSources.push(source);

          const gainNode = audioCtx.createGain();
          gainNode.gain.value = 0; // åˆæœŸçŠ¶æ…‹ã¯ãƒŸãƒ¥ãƒ¼ãƒˆ
          gainNodes.push(gainNode);

          source.connect(gainNode).connect(audioCtx.destination);
        } else {
          nameLabel.textContent = "No File";
          vid.src = "";
          vid.parentElement.querySelector('.placeholder-text').style.display = 'block';
          wrapper.classList.remove('is-audio');
          // ãƒ€ãƒŸãƒ¼ã®GainNodeã‚’å…¥ã‚Œã¦é…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãšã‚Œã‚’é˜²ãï¼ˆå¿µã®ç‚ºï¼‰
          const dummyGain = audioCtx.createGain();
          gainNodes.push(dummyGain);
        }
      }

      if (videoElements[0].src) {
        videoElements[0].onloadedmetadata = () => {
          masterDuration = videoElements[0].duration;
          seek.max = masterDuration;
        };
      }
    });

    // --- éŸ³é‡å¤‰æ›´ (ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œ) ---
    window.changeVolume = function (index, value) {
      if (!gainNodes[index]) return;
      initAudioContext();

      const floatVal = parseFloat(value);
      channelStates[index].volume = floatVal; // è¨­å®šå€¤ã‚’è¨˜æ†¶

      // ãƒŸãƒ¥ãƒ¼ãƒˆä¸­ã§ãªã‘ã‚Œã°ã€å³åº§ã«éŸ³é‡ã‚’åæ˜ 
      if (!channelStates[index].muted) {
        // ãƒ•ã‚§ãƒ¼ãƒ‰ãªã—ã§å³æ™‚åæ˜ ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œã®è¿½å¾“æ€§ã‚’è‰¯ãã™ã‚‹ãŸã‚ï¼‰
        gainNodes[index].gain.setTargetAtTime(floatVal, audioCtx.currentTime, 0.01);
      }
    };

    // --- ON/OFF åˆ‡æ›¿ (ãƒœã‚¿ãƒ³æ“ä½œ) ---
    window.toggleAudio = function (index) {
      if (!gainNodes[index]) return;
      initAudioContext();

      const btn = btnElements[index];
      const state = channelStates[index];

      if (state.muted) {
        // éŸ³å£°ã‚’ONã«ã™ã‚‹ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã¾ã§ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ï¼‰
        state.muted = false;
        gainNodes[index].gain.setTargetAtTime(state.volume, audioCtx.currentTime, 0.1);
        btn.classList.add('active');
        btn.textContent = "ON";
      } else {
        // éŸ³å£°ã‚’OFFã«ã™ã‚‹ï¼ˆ0ã¾ã§ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼‰
        state.muted = true;
        gainNodes[index].gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
        btn.classList.remove('active');
        btn.textContent = "OFF";
      }
    };

    playBtn.addEventListener('click', () => {
      initAudioContext();
      if (isPlaying) {
        videoElements.forEach(v => { if (v.src) v.pause(); });
        playBtn.textContent = "Play";
      } else {
        videoElements.forEach(v => { if (v.src) v.play(); });
        playBtn.textContent = "Pause";
      }
      isPlaying = !isPlaying;
    });

    seek.addEventListener('input', (e) => {
      const time = parseFloat(e.target.value);
      videoElements.forEach(v => {
        if (v.src) {
          v.currentTime = time;
          v.playbackRate = 1.0;
        }
      });
      updateTimeDisplay(time);
    });

    videoElements[0].addEventListener('timeupdate', () => {
      if (!seek.matches(':active') && videoElements[0].duration) {
        seek.value = videoElements[0].currentTime;
        updateTimeDisplay(videoElements[0].currentTime);
      }
    });

    function updateTimeDisplay(time) {
      if (isNaN(time)) time = 0;
      const m = Math.floor(time / 60).toString().padStart(2, '0');
      const s = Math.floor(time % 60).toString().padStart(2, '0');
      timeDisplay.textContent = `${m}:${s}`;
    }

    // åŒæœŸå‡¦ç†
    setInterval(() => {
      if (!isPlaying || !videoElements[0].src) return;
      const masterTime = videoElements[0].currentTime;

      videoElements.forEach((v, i) => {
        if (i === 0 || !v.src) return;

        const diff = v.currentTime - masterTime;
        const statusEl = statusElements[i];

        if (Math.abs(diff) < 0.05) {
          v.playbackRate = 1.0;
          statusEl.textContent = "Sync: Perfect";
          statusEl.style.color = "#888";
        } else if (Math.abs(diff) > 0.5) {
          v.currentTime = masterTime;
          statusEl.textContent = "Sync: JUMP";
          statusEl.style.color = "red";
        } else {
          v.playbackRate = diff < 0 ? 1.05 : 0.95;
          statusEl.textContent = `Sync: ${diff < 0 ? "Catching up" : "Waiting"}`;
          statusEl.style.color = "orange";
        }
      });
    }, 500);
  </script>
</body>

</html>