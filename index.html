<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCARTS-previewer</title>
  <style>
    /* --- Font Import (from style.css) --- */
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans:wght@100;300;400;700&family=Noto+Sans+JP:wght@100;300;400&display=swap');

    /* --- Base Styles --- */
    body {
      margin: 0;
      /* æ¨ªå¹…ã‚’æœ‰åŠ¹æ´»ç”¨ã™ã‚‹ãŸã‚ä½™ç™½ã‚’æ¸›ã‚‰ã™ */
      padding: 10px;
      /* æŒ‡å®šã®ãƒ–ãƒ«ãƒ¼ */
      background-color: #1c1bd8;
      color: #fff;
      font-family: "Noto Sans", "Noto Sans JP", sans-serif;
      -webkit-font-smoothing: antialiased;
      font-weight: 100;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 140px;
      min-height: 100vh;
      box-sizing: border-box;
      overflow-x: hidden;
      /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
    }

    h3 {
      font-weight: 100;
      letter-spacing: 0.15em;
      margin: 0 0 10px 0;
    }

    p {
      font-weight: 300;
      letter-spacing: 0.05em;
    }

    /* --- File Select Area --- */
    .file-select-area {
      background: rgba(0, 0, 0, 0.2);
      padding: 20px;
      border-radius: 2px;
      margin-bottom: 30px;
      text-align: center;
      width: 95%;
      /* å¹…ã‚’åºƒã’ã‚‹ */
      max-width: 1200px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      margin-top: 20px;
    }

    /* --- Lyrics Box --- */
    .lyrics-box {
      background: transparent;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      width: 95%;
      /* å¹…ã‚’åºƒã’ã‚‹ */
      max-width: 1200px;
      height: 150px;
      overflow-y: auto;
      margin-top: 10px;
      padding: 20px 0;
      margin-bottom: 30px;
      white-space: pre-wrap;
      font-size: 1rem;
      line-height: 1.8;
      color: rgba(255, 255, 255, 0.9);
      text-align: center;
      font-weight: 400;
      letter-spacing: 0.05em;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
    }

    .lyrics-box::-webkit-scrollbar {
      width: 6px;
    }

    .lyrics-box::-webkit-scrollbar-thumb {
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
    }

    /* --- Video Grid (ã“ã“ã‚’å¤§ããå¤‰æ›´) --- */
    .video-grid {
      display: grid;
      /* æœ€å°å¹…ã‚’480pxã«æ‹¡å¤§ã—ã¦ã€ä¸€ã¤ä¸€ã¤ã‚’å¤§ããè¡¨ç¤º */
      grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
      gap: 20px;
      width: 98%;
      /* ã»ã¼å…¨å¹… */
      max-width: 100%;
      /* åˆ¶é™è§£é™¤ */
    }

    .channel-box {
      background: #000;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: border-color 0.3s;
    }

    .channel-box:hover {
      border-color: rgba(255, 255, 255, 0.8);
    }

    .file-name-display {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 0.85rem;
      padding: 8px 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-weight: 300;
      letter-spacing: 0.05em;
    }

    .video-wrapper {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #111;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      position: relative;
      z-index: 1;
    }

    .placeholder-text {
      position: absolute;
      font-size: 3rem;
      /* æ–‡å­—ã‚‚å¤§ãã */
      color: rgba(255, 255, 255, 0.2);
      font-weight: 100;
      z-index: 0;
    }

    .audio-icon {
      display: none;
      position: absolute;
      font-size: 4rem;
      /* ã‚¢ã‚¤ã‚³ãƒ³ã‚‚å¤§ãã */
      color: rgba(255, 255, 255, 0.8);
      z-index: 2;
      flex-direction: column;
      align-items: center;
      font-weight: 100;
    }

    .audio-icon span {
      font-size: 1rem;
      margin-top: 10px;
      color: rgba(255, 255, 255, 0.6);
      letter-spacing: 0.1em;
    }

    .video-wrapper.is-audio video {
      opacity: 0;
    }

    .video-wrapper.is-audio .audio-icon {
      display: flex;
    }

    /* --- Individual Controls --- */
    .controls-row {
      display: flex;
      align-items: center;
      background: rgba(0, 0, 0, 0.8);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 10px 15px;
      gap: 15px;
    }

    .audio-btn {
      flex-grow: 1;
      padding: 6px 12px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: transparent;
      color: rgba(255, 255, 255, 0.6);
      font-family: "Noto Sans", sans-serif;
      font-size: 0.85rem;
      cursor: pointer;
      border-radius: 2px;
      transition: all 0.3s;
      font-weight: 300;
      letter-spacing: 0.1em;
    }

    .audio-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border-color: #fff;
    }

    .audio-btn.active {
      background: #fff;
      color: #1c1bd8;
      border-color: #fff;
      font-weight: 400;
    }

    /* ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
    .vol-slider {
      width: 100px;
      /* å°‘ã—é•·ã */
      cursor: pointer;
      height: 3px;
      -webkit-appearance: none;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 1px;
    }

    .vol-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: #fff;
      border-radius: 50%;
      cursor: pointer;
    }

    .sync-status {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.5);
      text-align: center;
      padding: 3px;
      background: #000;
      letter-spacing: 0.05em;
    }

    /* --- Main Controls (Footer) --- */
    .main-controls {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(5px);
      padding: 20px 40px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      gap: 30px;
      z-index: 1000;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    button.play-btn {
      width: 120px;
      height: 50px;
      cursor: pointer;
      font-size: 1.2rem;
      background: transparent;
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 2px;
      font-family: "Noto Sans", sans-serif;
      font-weight: 300;
      letter-spacing: 0.15em;
      transition: all 0.3s;
    }

    button.play-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #fff;
    }

    input[type="range"] {
      cursor: pointer;
    }

    #masterSeek {
      flex-grow: 1;
      height: 4px;
      -webkit-appearance: none;
      background: rgba(255, 255, 255, 0.3);
    }

    #masterSeek::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: #fff;
      border-radius: 50%;
      cursor: pointer;
    }

    .time-display {
      font-family: "Noto Sans", monospace;
      width: 100px;
      text-align: right;
      font-size: 1.2rem;
      font-weight: 300;
      letter-spacing: 0.05em;
    }
  </style>
</head>

<body>

  <div class="file-select-area">
    <h3>STEP 1</h3>
    <p style="margin:5px 0; font-size:1rem; color:rgba(255,255,255,0.7);">å‹•ç”»ãƒ»éŸ³å£°ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„<br><span
        style="font-size:0.85rem; opacity:0.6;">â€»ãƒ•ã‚¡ã‚¤ãƒ«åé †ã«1ï½7ç•ªã¸å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ (mp4, mp3, wavç­‰)</span></p>
    <input type="file" id="folderInput" webkitdirectory directory multiple
      style="margin-top:15px; font-family:'Noto Sans'; font-size:1rem;">
  </div>

  <div class="video-grid">
    <script>
      // 7å€‹åˆ†ã®HTMLæ ã‚’ç”Ÿæˆ
      for (let i = 1; i <= 7; i++) {
        document.write(`
          <div class="channel-box">
              <div class="file-name-display" id="fname${i}">No File</div>
              <div class="video-wrapper" id="wrap${i}">
                  <span class="placeholder-text">${i}</span>
                  <div class="audio-icon">
                    ğŸµ
                    <span>Audio Only</span>
                  </div>
                  <video id="vid${i}" playsinline></video>
              </div>
              <div class="sync-status" id="status${i}">Sync: OK</div>
              <div class="controls-row">
                  <button class="audio-btn" id="btn${i}" onclick="toggleAudio(${i - 1})">OFF</button>
                  <input type="range" class="vol-slider" id="vol${i}" min="0" max="1" step="0.01" value="1" oninput="changeVolume(${i - 1}, this.value)">
              </div>
          </div>
        `);
      }
    </script>
  </div>

  <div class="main-controls">
    <button class="play-btn" id="masterPlay">Play</button>
    <input type="range" id="masterSeek" value="0" min="0" step="0.1">
    <span class="time-display" id="timeDisplay">00:00</span>
  </div>

  <div class="lyrics-box">
    çš¿ã®ã†ãˆã«è‚‰ã¯ã‚ã‚‹ã®ã«
    ã‚ãŸã—ã®è‚‰ä½“ã®çš¿ã¯ãªã„
    ã“ã¨ã‚ã–ã¿ãŸã„
    ã§ã‚‚ã ã‚Œã‚‚ã€€ã†ãªãšã‹ãªã„
    ç²˜èŒã¯è‚‰ã®ã†ãˆã‚’é€šã‚Š
    ä¸–ç•Œã‚’ã†ã‚“ã©ã†ã§ãŠã¼ãˆã‚‹
    ãã‚‹ã’ã‚‹ã€€ã‹ãŸã„ã’ã‚‹
    ã²ã‚„ã‚Šã€€ã¾ãŸã‚ã¤ã„
    å„é§…åœè»Šã€€å†·ã‚„æ±—
    ãŠæ¯ã•ã‚“ã¯è‚‰ã‚’å¢—ã‚„ã™ã€€ä¸å®‰ã®æ‰‹
    é£¼è‚²å°å±‹ã§è¼ªéƒ­ãŒã¨ã‘ã€€ã‚ãŸã—ãŒã¾ã–ã‚‹
    èŒ¶è‰²ã„å¡Šã€€ã†ã‚“ã“ã‹å›£å­ã‹
    ã‚·ãƒ£ãƒ¼ãƒ¬ã«ã½ã¤ã‚Šã€€éŸ³ã®ãªã„è‚‰
    ã†ãã¨ã»ã‚“ã¨ã†ã®æœ­ã€€ã‚†ã‚Œã‚‹
    å™›ã¾ã‚Œã¬è‚‰ã€€çœ ã‚‰ã¬è‚‰
    ç²˜èŒã®ã‚ã¨ã ã‘ã€€è¨¼æ˜ã¿ãŸã„ã«ã®ã“ã‚‹
  </div>

  <script>
    // è¦ç´ å–å¾—
    const videoElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`vid${i + 1}`));
    const btnElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`btn${i + 1}`));
    const volElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`vol${i + 1}`));
    const statusElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`status${i + 1}`));
    const nameElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`fname${i + 1}`));
    const wrapperElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`wrap${i + 1}`));

    const folderInput = document.getElementById('folderInput');
    const playBtn = document.getElementById('masterPlay');
    const seek = document.getElementById('masterSeek');
    const timeDisplay = document.getElementById('timeDisplay');

    let audioCtx;
    const gainNodes = [];
    let audioSources = [];

    // å„ãƒãƒ£ãƒ³ãƒãƒ«ã®çŠ¶æ…‹ç®¡ç† (volume: ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤, muted: ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹)
    const channelStates = Array.from({ length: 7 }, () => ({ volume: 1.0, muted: true }));

    let isPlaying = false;
    let masterDuration = 0;

    function initAudioContext() {
      if (!audioCtx) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
      }
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
    }

    folderInput.addEventListener('change', async (e) => {
      initAudioContext();

      const files = Array.from(e.target.files);
      const mediaFiles = files.filter(f =>
        f.type.startsWith('video/') ||
        f.type.startsWith('audio/') ||
        f.name.match(/\.(mp4|mov|webm|m4v|mkv|mp3|wav|aac|ogg)$/i)
      );

      if (mediaFiles.length === 0) {
        alert("å†ç”Ÿå¯èƒ½ãªãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«(å‹•ç”»/éŸ³å£°)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
        return;
      }

      mediaFiles.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));

      // ãƒªã‚»ãƒƒãƒˆ
      audioSources.forEach(src => src.disconnect());
      audioSources = [];
      gainNodes.length = 0;

      for (let i = 0; i < 7; i++) {
        const vid = videoElements[i];
        const btn = btnElements[i];
        const vol = volElements[i];
        const nameLabel = nameElements[i];
        const wrapper = wrapperElements[i];

        // çŠ¶æ…‹åˆæœŸåŒ–
        channelStates[i].muted = true;
        channelStates[i].volume = 1.0;
        vol.value = 1.0; // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’æœ€å¤§ã«æˆ»ã™
        btn.textContent = "OFF";
        btn.classList.remove('active');

        if (mediaFiles[i]) {
          const file = mediaFiles[i];
          const fileURL = URL.createObjectURL(file);

          vid.src = fileURL;
          vid.load();

          vid.parentElement.querySelector('.placeholder-text').style.display = 'none';
          nameLabel.textContent = file.name;
          nameLabel.title = file.name;

          const isAudio = file.type.startsWith('audio/') || file.name.match(/\.(mp3|wav|aac|ogg)$/i);
          if (isAudio) wrapper.classList.add('is-audio');
          else wrapper.classList.remove('is-audio');

          // Audio Node è¨­å®š
          const source = audioCtx.createMediaElementSource(vid);
          audioSources.push(source);

          const gainNode = audioCtx.createGain();
          gainNode.gain.value = 0; // åˆæœŸçŠ¶æ…‹ã¯ãƒŸãƒ¥ãƒ¼ãƒˆ
          gainNodes.push(gainNode);

          source.connect(gainNode).connect(audioCtx.destination);
        } else {
          nameLabel.textContent = "No File";
          vid.src = "";
          vid.parentElement.querySelector('.placeholder-text').style.display = 'block';
          wrapper.classList.remove('is-audio');
          // ãƒ€ãƒŸãƒ¼ã®GainNodeã‚’å…¥ã‚Œã¦é…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãšã‚Œã‚’é˜²ãï¼ˆå¿µã®ç‚ºï¼‰
          const dummyGain = audioCtx.createGain();
          gainNodes.push(dummyGain);
        }
      }

      if (videoElements[0].src) {
        videoElements[0].onloadedmetadata = () => {
          masterDuration = videoElements[0].duration;
          seek.max = masterDuration;
        };
      }
    });

    // --- éŸ³é‡å¤‰æ›´ (ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œ) ---
    window.changeVolume = function (index, value) {
      if (!gainNodes[index]) return;
      initAudioContext();

      const floatVal = parseFloat(value);
      channelStates[index].volume = floatVal; // è¨­å®šå€¤ã‚’è¨˜æ†¶

      // ãƒŸãƒ¥ãƒ¼ãƒˆä¸­ã§ãªã‘ã‚Œã°ã€å³åº§ã«éŸ³é‡ã‚’åæ˜ 
      if (!channelStates[index].muted) {
        // ãƒ•ã‚§ãƒ¼ãƒ‰ãªã—ã§å³æ™‚åæ˜ ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œã®è¿½å¾“æ€§ã‚’è‰¯ãã™ã‚‹ãŸã‚ï¼‰
        gainNodes[index].gain.setTargetAtTime(floatVal, audioCtx.currentTime, 0.01);
      }
    };

    // --- ON/OFF åˆ‡æ›¿ (ãƒœã‚¿ãƒ³æ“ä½œ) ---
    window.toggleAudio = function (index) {
      if (!gainNodes[index]) return;
      initAudioContext();

      const btn = btnElements[index];
      const state = channelStates[index];

      if (state.muted) {
        // éŸ³å£°ã‚’ONã«ã™ã‚‹ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã¾ã§ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ï¼‰
        state.muted = false;
        gainNodes[index].gain.setTargetAtTime(state.volume, audioCtx.currentTime, 0.1);
        btn.classList.add('active');
        btn.textContent = "ON";
      } else {
        // éŸ³å£°ã‚’OFFã«ã™ã‚‹ï¼ˆ0ã¾ã§ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼‰
        state.muted = true;
        gainNodes[index].gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
        btn.classList.remove('active');
        btn.textContent = "OFF";
      }
    };

    playBtn.addEventListener('click', () => {
      initAudioContext();
      if (isPlaying) {
        videoElements.forEach(v => { if (v.src) v.pause(); });
        playBtn.textContent = "Play";
      } else {
        videoElements.forEach(v => { if (v.src) v.play(); });
        playBtn.textContent = "Pause";
      }
      isPlaying = !isPlaying;
    });

    seek.addEventListener('input', (e) => {
      const time = parseFloat(e.target.value);
      videoElements.forEach(v => {
        if (v.src) {
          v.currentTime = time;
          v.playbackRate = 1.0;
        }
      });
      updateTimeDisplay(time);
    });

    videoElements[0].addEventListener('timeupdate', () => {
      if (!seek.matches(':active') && videoElements[0].duration) {
        seek.value = videoElements[0].currentTime;
        updateTimeDisplay(videoElements[0].currentTime);
      }
    });

    function updateTimeDisplay(time) {
      if (isNaN(time)) time = 0;
      const m = Math.floor(time / 60).toString().padStart(2, '0');
      const s = Math.floor(time % 60).toString().padStart(2, '0');
      timeDisplay.textContent = `${m}:${s}`;
    }

    // åŒæœŸå‡¦ç†
    setInterval(() => {
      if (!isPlaying || !videoElements[0].src) return;
      const masterTime = videoElements[0].currentTime;

      videoElements.forEach((v, i) => {
        if (i === 0 || !v.src) return;

        const diff = v.currentTime - masterTime;
        const statusEl = statusElements[i];

        if (Math.abs(diff) < 0.05) {
          v.playbackRate = 1.0;
          statusEl.textContent = "Sync: Perfect";
          statusEl.style.color = "rgba(255,255,255,0.5)";
        } else if (Math.abs(diff) > 0.5) {
          v.currentTime = masterTime;
          statusEl.textContent = "Sync: JUMP";
          statusEl.style.color = "#ff4444";
        } else {
          v.playbackRate = diff < 0 ? 1.05 : 0.95;
          statusEl.textContent = `Sync: ${diff < 0 ? "Catching up" : "Waiting"}`;
          statusEl.style.color = "#ffbb33";
        }
      });
    }, 500);
  </script>
</body>

</html>