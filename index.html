<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCARTS-previewer (Multi-Format)</title>
  <style>
    body {
      font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
      background-color: #222;
      color: #fff;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 140px;
    }

    .file-select-area {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      width: 90%;
      max-width: 800px;
      border: 2px dashed #555;
    }

    .lyrics-box {
      background: #111;
      border: 1px solid #444;
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      height: 150px;
      overflow-y: auto;
      margin-top: 20px;
      padding: 20px;
      margin-bottom: 30px;
      white-space: pre-wrap;
      font-size: 1rem;
      line-height: 1.8;
      color: #ddd;
      text-align: center;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 15px;
      width: 100%;
      max-width: 1400px;
    }

    .channel-box {
      background: #000;
      border: 1px solid #444;
      border-radius: 6px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .file-name-display {
      background: #333;
      color: #fff;
      font-size: 0.8rem;
      padding: 4px 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-bottom: 1px solid #444;
    }

    .video-wrapper {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #111;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      position: relative;
      z-index: 1;
    }

    /* ç•ªå·è¡¨ç¤ºç”¨ */
    .placeholder-text {
      position: absolute;
      font-size: 2rem;
      color: #555;
      font-weight: bold;
      z-index: 0;
    }

    /* éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ã®ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º */
    .audio-icon {
      display: none;
      /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯éè¡¨ç¤º */
      position: absolute;
      font-size: 3rem;
      color: #4CAF50;
      z-index: 2;
      flex-direction: column;
      align-items: center;
    }

    .audio-icon span {
      font-size: 0.8rem;
      margin-top: 5px;
      color: #aaa;
    }

    /* ã‚¯ãƒ©ã‚¹ãŒä»˜ä¸ã•ã‚ŒãŸã‚‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤ºã—ã€ãƒ“ãƒ‡ã‚ªï¼ˆé»’ç”»é¢ï¼‰ã‚’éš ã™ */
    .video-wrapper.is-audio video {
      opacity: 0;
    }

    .video-wrapper.is-audio .audio-icon {
      display: flex;
    }


    .audio-btn {
      width: 100%;
      padding: 10px;
      border: none;
      background: #444;
      color: #ccc;
      font-size: 0.9rem;
      cursor: pointer;
      border-top: 1px solid #333;
    }

    .audio-btn:hover {
      background: #555;
    }

    .audio-btn.active {
      background: #4CAF50;
      color: #fff;
      font-weight: bold;
    }

    .sync-status {
      font-size: 0.75rem;
      color: #666;
      text-align: center;
      padding: 2px;
      background: #1a1a1a;
    }

    .main-controls {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.95);
      padding: 15px 30px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      gap: 20px;
      z-index: 1000;
      border-top: 1px solid #444;
    }

    button.play-btn {
      width: 80px;
      height: 40px;
      cursor: pointer;
      font-size: 1rem;
      background: #fff;
      color: #000;
      border: none;
      border-radius: 4px;
      font-weight: bold;
    }

    input[type="range"] {
      flex-grow: 1;
      cursor: pointer;
      height: 10px;
    }

    .time-display {
      font-family: monospace;
      width: 100px;
      text-align: right;
      font-size: 1.2rem;
    }
  </style>
</head>

<body>

  <div class="file-select-area">
    <h3>STEP 1: å‹•ç”»ãƒ»éŸ³å£°ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</h3>
    <p style="margin:5px 0; font-size:0.9rem; color:#aaa;">â€»ãƒ•ã‚¡ã‚¤ãƒ«åé †ã«1ï½7ç•ªã¸å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ (mp4, mp3, wavç­‰)</p>
    <input type="file" id="folderInput" webkitdirectory directory multiple>
  </div>

  <div class="video-grid">
    <script>
      // 7å€‹åˆ†ã®HTMLæ ã‚’ç”Ÿæˆ
      for (let i = 1; i <= 7; i++) {
        document.write(`
          <div class="channel-box">
              <div class="file-name-display" id="fname${i}">No File</div>
              <div class="video-wrapper" id="wrap${i}">
                  <span class="placeholder-text">${i}</span>
                  <div class="audio-icon">
                    ğŸµ
                    <span>Audio Only</span>
                  </div>
                  <video id="vid${i}" playsinline></video>
              </div>
              <div class="sync-status" id="status${i}">Sync: OK</div>
              <button class="audio-btn" id="btn${i}" onclick="toggleAudio(${i - 1})">Sound ${i}: OFF</button>
          </div>
        `);
      }
    </script>
  </div>

  <div class="main-controls">
    <button class="play-btn" id="masterPlay">Play</button>
    <input type="range" id="masterSeek" value="0" min="0" step="0.1">
    <span class="time-display" id="timeDisplay">00:00</span>
  </div>

  <div class="lyrics-box">
    Lyrics(ã“ã“ã«æ­Œè©ãŒå…¥ã‚Šã¾ã™)
  </div>

  <script>
    // è¦ç´ å–å¾—
    const videoElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`vid${i + 1}`));
    const btnElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`btn${i + 1}`));
    const statusElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`status${i + 1}`));
    const nameElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`fname${i + 1}`));
    const wrapperElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`wrap${i + 1}`));

    const folderInput = document.getElementById('folderInput');
    const playBtn = document.getElementById('masterPlay');
    const seek = document.getElementById('masterSeek');
    const timeDisplay = document.getElementById('timeDisplay');

    let audioCtx;
    const gainNodes = [];
    let audioSources = [];
    let isPlaying = false;
    let masterDuration = 0;

    function initAudioContext() {
      if (!audioCtx) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
      }
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
    }

    folderInput.addEventListener('change', async (e) => {
      initAudioContext();

      const files = Array.from(e.target.files);

      // ãƒ•ã‚£ãƒ«ã‚¿æ‹¡å¼µ: videoç³» ã¾ãŸã¯ audioç³» ã¾ãŸã¯ ç‰¹å®šã®æ‹¡å¼µå­
      const mediaFiles = files.filter(f =>
        f.type.startsWith('video/') ||
        f.type.startsWith('audio/') ||
        f.name.match(/\.(mp4|mov|webm|m4v|mkv|mp3|wav|aac|ogg)$/i)
      );

      if (mediaFiles.length === 0) {
        alert("å†ç”Ÿå¯èƒ½ãªãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«(å‹•ç”»/éŸ³å£°)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
        return;
      }

      // åå‰é †ã‚½ãƒ¼ãƒˆ
      mediaFiles.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));

      // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¨­å®šãƒªã‚»ãƒƒãƒˆ
      audioSources.forEach(src => src.disconnect());
      audioSources = [];
      gainNodes.length = 0;

      for (let i = 0; i < 7; i++) {
        const vid = videoElements[i];
        const btn = btnElements[i];
        const nameLabel = nameElements[i];
        const wrapper = wrapperElements[i];

        if (mediaFiles[i]) {
          const file = mediaFiles[i];
          const fileURL = URL.createObjectURL(file);

          vid.src = fileURL;
          vid.load();

          // UIæ›´æ–°
          vid.parentElement.querySelector('.placeholder-text').style.display = 'none';
          nameLabel.textContent = file.name;
          nameLabel.title = file.name;

          // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã©ã†ã‹ã®åˆ¤å®šï¼ˆæ‹¡å¼µå­ã¾ãŸã¯MIMEã‚¿ã‚¤ãƒ—ï¼‰
          const isAudio = file.type.startsWith('audio/') || file.name.match(/\.(mp3|wav|aac|ogg)$/i);

          if (isAudio) {
            wrapper.classList.add('is-audio'); // éŸ³ç¬¦ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
          } else {
            wrapper.classList.remove('is-audio'); // é€šå¸¸ã®å‹•ç”»è¡¨ç¤º
          }

          // Soundè¨­å®š (Web Audio API)
          const source = audioCtx.createMediaElementSource(vid);
          audioSources.push(source);

          const gainNode = audioCtx.createGain();
          gainNode.gain.value = 0;
          gainNodes.push(gainNode);

          source.connect(gainNode).connect(audioCtx.destination);

          btn.textContent = `Sound ${i + 1}: OFF`;
          btn.classList.remove('active');
        } else {
          // ãƒ•ã‚¡ã‚¤ãƒ«ä¸è¶³æ™‚ã®å‡¦ç†
          nameLabel.textContent = "No File";
          vid.src = "";
          vid.parentElement.querySelector('.placeholder-text').style.display = 'block';
          wrapper.classList.remove('is-audio');
        }
      }

      // ãƒã‚¹ã‚¿ãƒ¼ï¼ˆ1ã¤ç›®ï¼‰ã®é•·ã•å–å¾—
      if (videoElements[0].src) {
        videoElements[0].onloadedmetadata = () => {
          masterDuration = videoElements[0].duration;
          seek.max = masterDuration;
        };
      }
    });

    window.toggleAudio = function (index) {
      if (!gainNodes[index]) return;
      initAudioContext();

      const currentGain = gainNodes[index].gain.value;
      const btn = btnElements[index];

      if (currentGain === 0) {
        gainNodes[index].gain.setTargetAtTime(1, audioCtx.currentTime, 0.1);
        btn.classList.add('active');
        btn.textContent = `Sound ${index + 1}: ON`;
      } else {
        gainNodes[index].gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
        btn.classList.remove('active');
        btn.textContent = `Sound ${index + 1}: OFF`;
      }
    };

    playBtn.addEventListener('click', () => {
      initAudioContext();
      if (isPlaying) {
        videoElements.forEach(v => { if (v.src) v.pause(); });
        playBtn.textContent = "Play";
      } else {
        videoElements.forEach(v => { if (v.src) v.play(); });
        playBtn.textContent = "Pause";
      }
      isPlaying = !isPlaying;
    });

    seek.addEventListener('input', (e) => {
      const time = parseFloat(e.target.value);
      videoElements.forEach(v => {
        if (v.src) {
          v.currentTime = time;
          v.playbackRate = 1.0;
        }
      });
      updateTimeDisplay(time);
    });

    videoElements[0].addEventListener('timeupdate', () => {
      if (!seek.matches(':active') && videoElements[0].duration) {
        seek.value = videoElements[0].currentTime;
        updateTimeDisplay(videoElements[0].currentTime);
      }
    });

    function updateTimeDisplay(time) {
      if (isNaN(time)) time = 0;
      const m = Math.floor(time / 60).toString().padStart(2, '0');
      const s = Math.floor(time % 60).toString().padStart(2, '0');
      timeDisplay.textContent = `${m}:${s}`;
    }

    // ãƒ”ãƒƒãƒãƒ™ãƒ³ãƒ‰åŒæœŸï¼ˆéŸ³é£›ã³é˜²æ­¢ï¼‰
    setInterval(() => {
      if (!isPlaying || !videoElements[0].src) return;
      const masterTime = videoElements[0].currentTime;

      videoElements.forEach((v, i) => {
        if (i === 0 || !v.src) return;

        const diff = v.currentTime - masterTime;
        const statusEl = statusElements[i];

        if (Math.abs(diff) < 0.05) {
          v.playbackRate = 1.0;
          statusEl.textContent = "Sync: Perfect";
          statusEl.style.color = "#888";
        } else if (Math.abs(diff) > 0.5) {
          v.currentTime = masterTime;
          statusEl.textContent = "Sync: JUMP";
          statusEl.style.color = "red";
        } else {
          v.playbackRate = diff < 0 ? 1.05 : 0.95;
          statusEl.textContent = `Sync: ${diff < 0 ? "Catching up" : "Waiting"}`;
          statusEl.style.color = "orange";
        }
      });
    }, 500);
  </script>
</body>

</html>