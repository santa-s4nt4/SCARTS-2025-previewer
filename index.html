<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCARTS-previewer (Volume Control)</title>
  <style>
    body {
      font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
      background-color: #222;
      color: #fff;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 140px;
    }

    .file-select-area {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      width: 90%;
      max-width: 800px;
      border: 2px dashed #555;
    }

    .lyrics-box {
      background: #111;
      border: 1px solid #444;
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      height: 150px;
      overflow-y: auto;
      margin-top: 20px;
      padding: 20px;
      margin-bottom: 30px;
      white-space: pre-wrap;
      font-size: 1rem;
      line-height: 1.8;
      color: #ddd;
      text-align: center;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 15px;
      width: 100%;
      max-width: 1400px;
    }

    .channel-box {
      background: #000;
      border: 1px solid #444;
      border-radius: 6px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .file-name-display {
      background: #333;
      color: #fff;
      font-size: 0.8rem;
      padding: 4px 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-bottom: 1px solid #444;
    }

    .video-wrapper {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #111;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      position: relative;
      z-index: 1;
    }

    .placeholder-text {
      position: absolute;
      font-size: 2rem;
      color: #555;
      font-weight: bold;
      z-index: 0;
    }

    .audio-icon {
      display: none;
      position: absolute;
      font-size: 3rem;
      color: #4CAF50;
      z-index: 2;
      flex-direction: column;
      align-items: center;
    }

    .audio-icon span {
      font-size: 0.8rem;
      margin-top: 5px;
      color: #aaa;
    }

    .video-wrapper.is-audio video {
      opacity: 0;
    }

    .video-wrapper.is-audio .audio-icon {
      display: flex;
    }

    /* „Ç≥„É≥„Éà„É≠„Éº„É´„Ç®„É™„Ç¢„ÅÆ„É¨„Ç§„Ç¢„Ç¶„ÉàÂ§âÊõ¥ */
    .controls-row {
      display: flex;
      align-items: center;
      background: #444;
      border-top: 1px solid #333;
      padding: 5px 10px;
      gap: 10px;
    }

    .audio-btn {
      flex-grow: 1;
      /* „Éú„Çø„É≥„ÇíÂ∫É„Åí„Çã */
      padding: 8px;
      border: none;
      background: #555;
      color: #ccc;
      font-size: 0.8rem;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .audio-btn:hover {
      background: #666;
    }

    .audio-btn.active {
      background: #4CAF50;
      color: #fff;
      font-weight: bold;
    }

    /* „Éú„É™„É•„Éº„É†„Çπ„É©„Ç§„ÉÄ„Éº */
    .vol-slider {
      width: 80px;
      cursor: pointer;
    }

    .sync-status {
      font-size: 0.75rem;
      color: #666;
      text-align: center;
      padding: 2px;
      background: #1a1a1a;
    }

    .main-controls {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.95);
      padding: 15px 30px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      gap: 20px;
      z-index: 1000;
      border-top: 1px solid #444;
    }

    button.play-btn {
      width: 80px;
      height: 40px;
      cursor: pointer;
      font-size: 1rem;
      background: #fff;
      color: #000;
      border: none;
      border-radius: 4px;
      font-weight: bold;
    }

    input[type="range"] {
      cursor: pointer;
    }

    /* „É°„Ç§„É≥„Ç∑„Éº„ÇØ„Éê„Éº„ÅØÂ§ß„Åç„Åè */
    #masterSeek {
      flex-grow: 1;
      height: 10px;
    }

    .time-display {
      font-family: monospace;
      width: 100px;
      text-align: right;
      font-size: 1.2rem;
    }
  </style>
</head>

<body>

  <div class="file-select-area">
    <h3>STEP 1: ÂãïÁîª„ÉªÈü≥Â£∞„Éï„Ç©„É´„ÉÄ„ÇíÈÅ∏Êäû</h3>
    <p style="margin:5px 0; font-size:0.9rem; color:#aaa;">‚Äª„Éï„Ç°„Ç§„É´ÂêçÈ†Ü„Å´1ÔΩû7Áï™„Å∏Ââ≤„ÇäÂΩì„Å¶„Çâ„Çå„Åæ„Åô (mp4, mp3, wavÁ≠â)</p>
    <input type="file" id="folderInput" webkitdirectory directory multiple>
  </div>

  <div class="video-grid">
    <script>
      // 7ÂÄãÂàÜ„ÅÆHTMLÊû†„ÇíÁîüÊàêÔºà„Çπ„É©„Ç§„ÉÄ„ÉºËøΩÂä†Ôºâ
      for (let i = 1; i <= 7; i++) {
        document.write(`
          <div class="channel-box">
              <div class="file-name-display" id="fname${i}">No File</div>
              <div class="video-wrapper" id="wrap${i}">
                  <span class="placeholder-text">${i}</span>
                  <div class="audio-icon">
                    üéµ
                    <span>Audio Only</span>
                  </div>
                  <video id="vid${i}" playsinline></video>
              </div>
              <div class="sync-status" id="status${i}">Sync: OK</div>
              <div class="controls-row">
                  <button class="audio-btn" id="btn${i}" onclick="toggleAudio(${i - 1})">OFF</button>
                  <input type="range" class="vol-slider" id="vol${i}" min="0" max="1" step="0.01" value="1" oninput="changeVolume(${i - 1}, this.value)">
              </div>
          </div>
        `);
      }
    </script>
  </div>

  <div class="main-controls">
    <button class="play-btn" id="masterPlay">Play</button>
    <input type="range" id="masterSeek" value="0" min="0" step="0.1">
    <span class="time-display" id="timeDisplay">00:00</span>
  </div>

  <div class="lyrics-box">
    Lyrics(„Åì„Åì„Å´Ê≠åË©û„ÅåÂÖ•„Çä„Åæ„Åô)
  </div>

  <script>
    // Ë¶ÅÁ¥†ÂèñÂæó
    const videoElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`vid${i + 1}`));
    const btnElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`btn${i + 1}`));
    const volElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`vol${i + 1}`));
    const statusElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`status${i + 1}`));
    const nameElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`fname${i + 1}`));
    const wrapperElements = Array.from({ length: 7 }, (_, i) => document.getElementById(`wrap${i + 1}`));

    const folderInput = document.getElementById('folderInput');
    const playBtn = document.getElementById('masterPlay');
    const seek = document.getElementById('masterSeek');
    const timeDisplay = document.getElementById('timeDisplay');

    let audioCtx;
    const gainNodes = [];
    let audioSources = [];

    // ÂêÑ„ÉÅ„É£„É≥„Éç„É´„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ (volume: „Çπ„É©„Ç§„ÉÄ„Éº„ÅÆÂÄ§, muted: „Éú„Çø„É≥„ÅÆÁä∂ÊÖã)
    const channelStates = Array.from({ length: 7 }, () => ({ volume: 1.0, muted: true }));

    let isPlaying = false;
    let masterDuration = 0;

    function initAudioContext() {
      if (!audioCtx) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
      }
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
    }

    folderInput.addEventListener('change', async (e) => {
      initAudioContext();

      const files = Array.from(e.target.files);
      const mediaFiles = files.filter(f =>
        f.type.startsWith('video/') ||
        f.type.startsWith('audio/') ||
        f.name.match(/\.(mp4|mov|webm|m4v|mkv|mp3|wav|aac|ogg)$/i)
      );

      if (mediaFiles.length === 0) {
        alert("ÂÜçÁîüÂèØËÉΩ„Å™„É°„Éá„Ç£„Ç¢„Éï„Ç°„Ç§„É´(ÂãïÁîª/Èü≥Â£∞)„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ");
        return;
      }

      mediaFiles.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));

      // „É™„Çª„ÉÉ„Éà
      audioSources.forEach(src => src.disconnect());
      audioSources = [];
      gainNodes.length = 0;

      for (let i = 0; i < 7; i++) {
        const vid = videoElements[i];
        const btn = btnElements[i];
        const vol = volElements[i];
        const nameLabel = nameElements[i];
        const wrapper = wrapperElements[i];

        // Áä∂ÊÖãÂàùÊúüÂåñ
        channelStates[i].muted = true;
        channelStates[i].volume = 1.0;
        vol.value = 1.0; // „Çπ„É©„Ç§„ÉÄ„Éº„ÇíÊúÄÂ§ß„Å´Êàª„Åô
        btn.textContent = "OFF";
        btn.classList.remove('active');

        if (mediaFiles[i]) {
          const file = mediaFiles[i];
          const fileURL = URL.createObjectURL(file);

          vid.src = fileURL;
          vid.load();

          vid.parentElement.querySelector('.placeholder-text').style.display = 'none';
          nameLabel.textContent = file.name;
          nameLabel.title = file.name;

          const isAudio = file.type.startsWith('audio/') || file.name.match(/\.(mp3|wav|aac|ogg)$/i);
          if (isAudio) wrapper.classList.add('is-audio');
          else wrapper.classList.remove('is-audio');

          // Audio Node Ë®≠ÂÆö
          const source = audioCtx.createMediaElementSource(vid);
          audioSources.push(source);

          const gainNode = audioCtx.createGain();
          gainNode.gain.value = 0; // ÂàùÊúüÁä∂ÊÖã„ÅØ„Éü„É•„Éº„Éà
          gainNodes.push(gainNode);

          source.connect(gainNode).connect(audioCtx.destination);
        } else {
          nameLabel.textContent = "No File";
          vid.src = "";
          vid.parentElement.querySelector('.placeholder-text').style.display = 'block';
          wrapper.classList.remove('is-audio');
          // „ÉÄ„Éü„Éº„ÅÆGainNode„ÇíÂÖ•„Çå„Å¶ÈÖçÂàó„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Åö„Çå„ÇíÈò≤„ÅêÔºàÂøµ„ÅÆÁÇ∫Ôºâ
          const dummyGain = audioCtx.createGain();
          gainNodes.push(dummyGain);
        }
      }

      if (videoElements[0].src) {
        videoElements[0].onloadedmetadata = () => {
          masterDuration = videoElements[0].duration;
          seek.max = masterDuration;
        };
      }
    });

    // --- Èü≥ÈáèÂ§âÊõ¥ („Çπ„É©„Ç§„ÉÄ„ÉºÊìç‰Ωú) ---
    window.changeVolume = function (index, value) {
      if (!gainNodes[index]) return;
      initAudioContext();

      const floatVal = parseFloat(value);
      channelStates[index].volume = floatVal; // Ë®≠ÂÆöÂÄ§„ÇíË®òÊÜ∂

      // „Éü„É•„Éº„Éà‰∏≠„Åß„Å™„Åë„Çå„Å∞„ÄÅÂç≥Â∫ß„Å´Èü≥Èáè„ÇíÂèçÊò†
      if (!channelStates[index].muted) {
        // „Éï„Çß„Éº„Éâ„Å™„Åó„ÅßÂç≥ÊôÇÂèçÊò†Ôºà„Çπ„É©„Ç§„ÉÄ„ÉºÊìç‰Ωú„ÅÆËøΩÂæìÊÄß„ÇíËâØ„Åè„Åô„Çã„Åü„ÇÅÔºâ
        gainNodes[index].gain.setTargetAtTime(floatVal, audioCtx.currentTime, 0.01);
      }
    };

    // --- ON/OFF ÂàáÊõø („Éú„Çø„É≥Êìç‰Ωú) ---
    window.toggleAudio = function (index) {
      if (!gainNodes[index]) return;
      initAudioContext();

      const btn = btnElements[index];
      const state = channelStates[index];

      if (state.muted) {
        // Èü≥Â£∞„ÇíON„Å´„Åô„ÇãÔºà„Çπ„É©„Ç§„ÉÄ„Éº„ÅÆÂÄ§„Åæ„Åß„Éï„Çß„Éº„Éâ„Ç§„É≥Ôºâ
        state.muted = false;
        gainNodes[index].gain.setTargetAtTime(state.volume, audioCtx.currentTime, 0.1);
        btn.classList.add('active');
        btn.textContent = "ON";
      } else {
        // Èü≥Â£∞„ÇíOFF„Å´„Åô„ÇãÔºà0„Åæ„Åß„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÔºâ
        state.muted = true;
        gainNodes[index].gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
        btn.classList.remove('active');
        btn.textContent = "OFF";
      }
    };

    playBtn.addEventListener('click', () => {
      initAudioContext();
      if (isPlaying) {
        videoElements.forEach(v => { if (v.src) v.pause(); });
        playBtn.textContent = "Play";
      } else {
        videoElements.forEach(v => { if (v.src) v.play(); });
        playBtn.textContent = "Pause";
      }
      isPlaying = !isPlaying;
    });

    seek.addEventListener('input', (e) => {
      const time = parseFloat(e.target.value);
      videoElements.forEach(v => {
        if (v.src) {
          v.currentTime = time;
          v.playbackRate = 1.0;
        }
      });
      updateTimeDisplay(time);
    });

    videoElements[0].addEventListener('timeupdate', () => {
      if (!seek.matches(':active') && videoElements[0].duration) {
        seek.value = videoElements[0].currentTime;
        updateTimeDisplay(videoElements[0].currentTime);
      }
    });

    function updateTimeDisplay(time) {
      if (isNaN(time)) time = 0;
      const m = Math.floor(time / 60).toString().padStart(2, '0');
      const s = Math.floor(time % 60).toString().padStart(2, '0');
      timeDisplay.textContent = `${m}:${s}`;
    }

    // ÂêåÊúüÂá¶ÁêÜ
    setInterval(() => {
      if (!isPlaying || !videoElements[0].src) return;
      const masterTime = videoElements[0].currentTime;

      videoElements.forEach((v, i) => {
        if (i === 0 || !v.src) return;

        const diff = v.currentTime - masterTime;
        const statusEl = statusElements[i];

        if (Math.abs(diff) < 0.05) {
          v.playbackRate = 1.0;
          statusEl.textContent = "Sync: Perfect";
          statusEl.style.color = "#888";
        } else if (Math.abs(diff) > 0.5) {
          v.currentTime = masterTime;
          statusEl.textContent = "Sync: JUMP";
          statusEl.style.color = "red";
        } else {
          v.playbackRate = diff < 0 ? 1.05 : 0.95;
          statusEl.textContent = `Sync: ${diff < 0 ? "Catching up" : "Waiting"}`;
          statusEl.style.color = "orange";
        }
      });
    }, 500);
  </script>
</body>

</html>